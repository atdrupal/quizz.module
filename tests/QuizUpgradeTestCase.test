<?php

use Drupal\quizz_question\Entity\QuestionType;

abstract class QuizUpgradeBaseTestCase extends UpdatePathTestCase {

  protected static $testDumpFile = 'â€¦';
  protected static $dependencies = array('ctools', 'entity', 'filter', 'views', 'views_bulk_operations', 'xautoload');
  protected static $testDescription = 'Test an upgrade from various Quiz versions.';
  protected static $subModules = array('long_answer', 'matching', 'multichoice', 'quiz_ddlines', 'quizz_question', 'short_answer', 'quizz_truefalse');

  /**
   * Some warnings are produced by other modules, we cann't do anything, just
   * ignore them all.
   *
   * @var bool
   */
  private $ignoreErrors = TRUE;

  protected function error($message = '', $group = 'Other', array $caller = NULL) {
    if (FALSE === $this->ignoreErrors) {
      return parent::error($message, $group, $caller);
    }
    return $this->assertTrue(TRUE, "[$group] {$message}", 'Debug');
  }

  public function setUp() {
    $this->databaseDumpFiles = array(drupal_get_path('module', 'quizz') . '/tests/upgrade/' . static::$testDumpFile);
    module_enable(static::$dependencies);
    drupal_flush_all_caches();
    parent::setUp();

    // Module renamed from quiz to quizz, quiz_question to quizz_question
    $sql_1 = 'UPDATE {system} SET name = :name WHERE name = :old_name AND type = :module';
    db_query($sql_1, array(':module' => 'module', 'old_name' => 'quiz', 'name' => 'quizz'));
    db_query($sql_1, array(':module' => 'module', 'old_name' => 'quiz_question', 'name' => 'quizz_question'));
    # db_query($sql_1, array(':module' => 'module', 'old_name' => 'scale', 'name' => 'quizz_scale'));
    db_query($sql_1, array(':module' => 'module', 'old_name' => 'truefalse', 'name' => 'quizz_truefalse'));

    module_enable(static::$dependencies);
    registry_rebuild();
    drupal_flush_all_caches();
    $this->loadedModules = module_list();
  }

  private function getPreupgradeInfo() {
    $info = array();

    // Store variables
    $variables = db_query('SELECT * FROM {variable} WHERE 1')->fetchAllKeyed();
    foreach ($variables as $name => $value) {
      $info['config'][$name] = unserialize($value);
    }

    // Count
    $sql = 'SELECT COUNT(*) FROM {node} WHERE type = :type';
    $info['count'] = array(
        'quiz'         => db_query($sql, array(':type' => 'quiz'))->fetchColumn(),
        'long_answer'  => db_query($sql, array(':type' => 'long_answer'))->fetchColumn(),
        'matching'     => db_query($sql, array(':type' => 'matching'))->fetchColumn(),
        'quiz_page'    => db_query($sql, array(':type' => 'quiz_page'))->fetchColumn(),
        # 'scale'        => db_query($sql, array(':type' => 'scale'))->fetchColumn(),
        'short_answer' => db_query($sql, array(':type' => 'short_answer'))->fetchColumn(),
        'truefalse'    => db_query($sql, array(':type' => 'truefalse'))->fetchColumn(),
    );

    return $info;
  }

  public function testUpgrade() {
    $info = $this->getPreupgradeInfo();
    if ($this->performUpgrade()) {
      $this->checkSchemas();
      $this->checkConfiguration($info);
      $this->checkDataMigration($info);
    }
  }

  /**
   * Make sure schemas are upgraded correctly.
   */
  private function checkSchemas() {
    foreach (static::$subModules as $module) {
      $this->assertTrue(module_exists($module), "Module {$module} is enabled.");
      if ($schema = module_invoke($module, 'schema')) {
        $this->checkSchema($schema);
      }
    }
  }

  private function checkSchema($schema) {
    foreach ($schema as $table_name => $table) {
      $this->assertTrue($table_exists = db_table_exists($table_name), "Table {$table_name} is available.");
      if (!$table_exists) {
        continue;
      }

      foreach (array_keys($table['fields']) as $field_name) {
        $this->assertTrue(db_field_exists($table_name, $field_name), "Field {$table_name}.{$field_name} is available.");
      }

      if (!empty($table['indexes'])) {
        foreach (array_keys($table['indexes']) as $index_name) {
          $this->assertTrue(db_index_exists($table_name, $index_name), "Found index {$table_name}.{$index_name}");
        }
      }
    }
  }

  /**
   * Make sure configuration are upgraded correctly.
   */
  private function checkConfiguration(array $info) {
    // Check configuration for quiz.
    $type = quizz_type_load('quiz');

    $vars = array();
    $vars[] = 'quiz_auto_revisioning';
    $vars[] = 'quiz_default_close';
    $vars[] = 'quiz_use_passfail';
    $vars[] = 'quiz_max_result_options';
    $vars[] = 'build_on_last';
    $vars[] = 'quiz_remove_partial_quiz_record';
    $vars[] = 'quiz_pager_start';
    $vars[] = 'quiz_pager_siblings';
    foreach ($vars as $var) {
      if (isset($info['config'][$var])) {
        $this->assertEqual($info['config'][$var], $type->getConfig($var), "{$var} is upgraded correctly.");
      }
    }

    // Check body field is there for quiz content type.
    $this->assertTrue(NULL !== field_info_instance('quiz_entity', 'quiz_body', 'quiz'), 'Quiz bundle has body field.');

    // Make sure question types are converted from node types
    $question_types = quizz_question_get_types();
    $this->assertTrue($question_types['long_answer'] instanceof QuestionType);
    $this->assertTrue($question_types['matching'] instanceof QuestionType);
    $this->assertTrue($question_types['multichoice'] instanceof QuestionType);
    $this->assertTrue($question_types['quiz_ddlines'] instanceof QuestionType);
    $this->assertTrue($question_types['quiz_directions'] instanceof QuestionType);
    $this->assertTrue($question_types['short_answer'] instanceof QuestionType);
    $this->assertTrue($question_types['truefalse'] instanceof QuestionType);
    # $this->assertTrue($question_types['scale'] instanceof QuestionType);
    $this->assertTrue($question_types['quiz_page'] instanceof QuestionType);

    // Check configuration for question types.
    foreach (quizz_question_get_types() as $question_type) {
      $question_settings = $question_type->getAllConfig();
      foreach ($question_settings as $name => $value) {
        $this->assertEqual($info['config'][$name], $value, "Question settings: Variable {$name} is upgraded correctly.");
      }
    }
  }

  private function checkDataMigration($info) {
    // Count quiz and questions
    $c_quiz = db_query('SELECT COUNT(*) FROM {quiz_entity}')->fetchColumn();
    $sql = 'SELECT COUNT(*) FROM {quiz_question} WHERE type = :type';
    $c_la = db_query($sql, array(':type' => 'long_answer'))->fetchColumn();
    $c_match = db_query($sql, array(':type' => 'matching'))->fetchColumn();
    $c_page = db_query($sql, array(':type' => 'quiz_page'))->fetchColumn();
    $c_scale = db_query($sql, array(':type' => 'scale'))->fetchColumn();
    $c_short = db_query($sql, array(':type' => 'short_answer'))->fetchColumn();
    $c_truefalse = db_query($sql, array(':type' => 'truefalse'))->fetchColumn();

    $this->assertEqual($info['count']['quiz'], $c_quiz, "Number of quizzes is not changed.");
    $this->assertEqual($info['count']['long_answer'], $c_la, "Number of long answer questions is not changed.");
    $this->assertEqual($info['count']['matching'], $c_match, "Number of match questions is not changed.");
    $this->assertEqual($info['count']['quiz_page'], $c_page, "Number of page questions is not changed.");
    $this->assertEqual($info['count']['short_answer'], $c_short, "Number of short-answer questions is not changed.");
    $this->assertEqual($info['count']['truefalse'], $c_truefalse, "Number of truefalse questions is not changed.");
    # $this->assertEqual($info['count']['scale'], $c_scale, "Number of scale questions is not changed.");

    // Check quiz body field's data is migrated.
    $this->assertTrue(!empty(quizz_load(1)->quiz_body['und'][0]['value']), "Quiz body field's data is migrated correctly.");

    // Check question's body field is migrated.
    $question_sql = 'SELECT quiz_question_body_value FROM {field_data_quiz_question_body} WHERE type <> "scale" LIMIT 1';
    $question_body = db_query($question_sql)->fetchColumn();
    $this->assertTrue(!empty($question_body), "Question body's data is migrated correctly.");

    // Check question's properties
    $tfq_id = db_query('SELECT qid FROM {quiz_question} WHERE type = :type', array(':type' => 'truefalse'))->fetchColumn();
    $property_found = db_query('SELECT 1 FROM {quiz_truefalse} WHERE qid = :qid', array(':qid' => $tfq_id))->fetchColumn();
    $this->assertTrue(!empty($property_found), "Question property is migrated correctly.");
  }

}

class QuizUpgradeFrom7x4xTestCase extends QuizUpgradeBaseTestCase {

  protected static $testDumpFile = 'quiz-4x.php.gz';

  public static function getInfo() {
    return array(
        'name'        => 'Quiz upgrade from 7.x-4.x',
        'description' => static::$testDescription,
        'group'       => 'Quiz upgrade',
    );
  }

}

/**
 * Step to create the image: ./tests/upgrade/quiz-5x-generator.bash
 */
class QuizUpgradeFrom7x5xTestCase extends QuizUpgradeBaseTestCase {

  protected static $testDumpFile = 'quiz-5x.php.gz';

  public static function getInfo() {
    return array(
        'name'        => 'Quiz upgrade from 7.x-5.x',
        'description' => static::$testDescription,
        'group'       => 'Quiz upgrade',
    );
  }

}
